
--------------new 
SELECT ROW_CODE,ROW_NAME,ROW_NAME_EN,VALUE1,
       VALUE2,VALUE3,VALUE4,VALUE5,VALUE6,VALUE7,
       VALUE8,VALUE9,VALUE10,VALUE11 
FROM 
(SELECT /*RCS.ORD,
       RES.INDEX_CODE,*/
       RCS.COLUMN_CODE,
       RCS.ROW_NAME,
       RCS.ROW_NAME_EN,
       RCS.ROW_CODE,
       SUM(RES.VALUE) AS VALUE
FROM BIAM_P_RPT_CONF_SHOW_FIN020 RCS
LEFT JOIN
(SELECT F2.INDEX_CODE,
       F2.PRODUCT_CODE,
       /*NVL(F2.COEFFICIENT,1),
       NVL(F2.VALUE1,0),  --第一个指标值为空时，次数为0
       CASE WHEN F2.CAL_LEVEL = '0' THEN 1 ELSE NVL(F2.VALUE2,0) END,
       NVL(F2.VALUE3,1),
       NVL(F2.VALUE4,1),
       NVL(F2.VALUE5,1),
       NVL(F2.VALUE6,1),*/
       SUM(NVL(F2.COEFFICIENT,1)*
       NVL(F2.VALUE1,0)*  --第一个指标值为空时，次数为0
       CASE WHEN F2.CAL_LEVEL = '0' THEN 1 ELSE NVL(F2.VALUE2,0) END* 
       NVL(F2.VALUE3,1)*
       NVL(F2.VALUE4,1)*
       NVL(F2.VALUE5,1)*
       NVL(F2.VALUE6,1)) AS VALUE
FROM 
(SELECT RC.ORD, 
       RC.INDEX_CODE,
       F.PRODUCT_CODE,
       RC.COEFFICIENT,
       RC.CAL_LEVEL,
       CASE WHEN RC.OPERATION1 IS NULL THEN SUM(CASE WHEN RC.CAL_INDEX1 = F.INDEX_CODE THEN VALUE END) ELSE RC.OPERATION1/SUM(CASE WHEN RC.CAL_INDEX1 = F.INDEX_CODE THEN VALUE END) END AS VALUE1,
       CASE WHEN RC.OPERATION2 IS NULL THEN SUM(CASE WHEN RC.CAL_INDEX2 = F.INDEX_CODE THEN VALUE END) ELSE RC.OPERATION2/SUM(CASE WHEN RC.CAL_INDEX2 = F.INDEX_CODE THEN VALUE END) END AS VALUE2,
       CASE WHEN RC.OPERATION3 IS NULL THEN SUM(CASE WHEN RC.CAL_INDEX3 = F.INDEX_CODE THEN VALUE END) ELSE RC.OPERATION3/SUM(CASE WHEN RC.CAL_INDEX3 = F.INDEX_CODE THEN VALUE END) END AS VALUE3,
       CASE WHEN RC.OPERATION4 IS NULL THEN SUM(CASE WHEN RC.CAL_INDEX4 = F.INDEX_CODE THEN VALUE END) ELSE RC.OPERATION4/SUM(CASE WHEN RC.CAL_INDEX4 = F.INDEX_CODE THEN VALUE END) END AS VALUE4,
       CASE WHEN RC.OPERATION5 IS NULL THEN SUM(CASE WHEN RC.CAL_INDEX5 = F.INDEX_CODE THEN VALUE END) ELSE RC.OPERATION5/SUM(CASE WHEN RC.CAL_INDEX5 = F.INDEX_CODE THEN VALUE END) END AS VALUE5,
       CASE WHEN RC.OPERATION6 IS NULL THEN SUM(CASE WHEN RC.CAL_INDEX6 = F.INDEX_CODE THEN VALUE END) ELSE RC.OPERATION6/SUM(CASE WHEN RC.CAL_INDEX6 = F.INDEX_CODE THEN VALUE END) END AS VALUE6
FROM (SELECT ROWNUM AS ORD,
       T1.REMARK,
       T1.INDEX_CODE,
       T1.CAL_LEVEL,
       NVL(T1.COEFFICIENT,1)*NVL(T2.COEFFICIENT,1) AS COEFFICIENT,
       NVL(T2.OPERATION1,T1.OPERATION1) AS OPERATION1,
       NVL(T2.OPERATION2,T1.OPERATION2) AS OPERATION2,
       NVL(T2.OPERATION3,T1.OPERATION3) AS OPERATION3,
       NVL(T2.OPERATION4,T1.OPERATION4) AS OPERATION4,
       NVL(T2.OPERATION5,T1.OPERATION5) AS OPERATION5,
       NVL(T2.OPERATION6,T1.OPERATION6) AS OPERATION6,
       NVL(T2.CAL_INDEX1,T1.CAL_INDEX1) AS CAL_INDEX1,
       NVL(T2.CAL_INDEX2,T1.CAL_INDEX2) AS CAL_INDEX2,
       NVL(T2.CAL_INDEX3,T1.CAL_INDEX3) AS CAL_INDEX3,
       NVL(T2.CAL_INDEX4,T1.CAL_INDEX4) AS CAL_INDEX4,
       NVL(T2.CAL_INDEX5,T1.CAL_INDEX5) AS CAL_INDEX5,
       NVL(T2.CAL_INDEX6,T1.CAL_INDEX6) AS CAL_INDEX6,
       T1.ATTRIBUTE1,
       T1.ATTRIBUTE2,
       T1.ATTRIBUTE3
FROM BIAM_P_RPT_CONF_CAL_FIN020 T1
LEFT JOIN BIAM_P_RPT_CONF_CAL_FIN020 T2
ON T1.CAL_INDEX1 = T2.INDEX_CODE
AND T2.INDEX_CODE LIKE 'BI%') RC, --配置表
(SELECT ID.INDEX_CODE,
      PD.PRODUCT_18INSURANCE_CODE AS PRODUCT_CODE,
      GD.ORG_LV2_CODE,
      SUM(FF.VALUE) AS VALUE
 FROM BIAM_RPT_F_FIN020 FF
INNER JOIN BIAM_INDEXES_D ID
   ON ID.INDEX_WID = FF.INDEX_WID
  AND ID.REPORT_CODE = 'FIN020'
INNER JOIN BIAM_ORG_D GD
   ON TO_NUMBER(FF.ORG_WID) = GD.ORG_WID
INNER JOIN BIAM_PRODUCT_D PD
   ON TO_NUMBER(FF.PRODUCT_WID) = PD.PRODUCT_WID
  AND PD.PRODUCT_18INSURANCE_CODE IN
      ('T2101', 'T2102', '02030011')
INNER JOIN BIAM_PERIOD_D RD
   ON FF.PERIOD_WID = RD.PERIOD_WID
WHERE FF.ATTRIBUTE1 IS NULL 
  AND RD.PERIOD_NAME = '2018-10'
  AND GD.ORG_LV2_CODE = '51'
GROUP BY ID.INDEX_CODE,
      PD.PRODUCT_18INSURANCE_CODE,
      GD.ORG_LV2_CODE
UNION ALL
SELECT ID.INDEX_CODE,
      FF.PRODUCT_WID,
      FF.ORG_WID,
      VALUE
 FROM BIAM_RPT_F_FIN020 FF
INNER JOIN BIAM_PERIOD_D PD
   ON PD.PERIOD_WID = FF.PERIOD_WID
INNER JOIN BIAM_INDEXES_D ID
   ON ID.INDEX_WID = FF.INDEX_WID
  AND ID.REPORT_CODE = 'FIN020'
WHERE FF.ATTRIBUTE1 = 'BX'
  AND PD.PERIOD_NAME = '2018-10'
  AND FF.ORG_WID = '51'
UNION ALL
SELECT ID.INDEX_CODE,
      DECODE(CDL.CLASSCODE,'31','T2101','32','T2102','311','02030011',NULL),
      OBD.ORG_LV2_CODE,
      SUM(VALUE) AS VALUE
FROM   BIAM_RPT_F_FIN020 FF
INNER JOIN BIAM_PERIOD_D PD
   ON PD.PERIOD_WID = FF.PERIOD_WID
INNER JOIN BIAM_INDEXES_D ID
  ON ID.INDEX_WID = FF.INDEX_WID
 AND ID.REPORT_CODE = 'FIN020'
INNER JOIN BIAM_PRODUCT_EXT_D PED
  ON FF.PRODUCT_WID = PED.PRODUCT_WID
 AND PED.DATA_SOURCE = 'BI'
INNER JOIN ods_cd_drisk2_level CDL
  ON CDL.RISKCODE = PED.PRODUCT_CODE
 AND CDL.CLASSCODE IN (31,311,32)
INNER JOIN BIAM_ORG_D OBD
  ON OBD.ORG_WID = FF.ORG_WID
WHERE FF.ATTRIBUTE1 = 'BI'
  AND PD.PERIOD_NAME = '2018-10'
  AND OBD.ORG_LV2_CODE = '51'
GROUP BY ID.INDEX_CODE,
      DECODE(CDL.CLASSCODE,'31','T2101','32','T2102','311','02030011',NULL),
      OBD.ORG_LV2_CODE) F
GROUP BY RC.ORD,  
       RC.INDEX_CODE,
       F.PRODUCT_CODE,
       RC.COEFFICIENT,
       RC.CAL_LEVEL, 
       RC.OPERATION1,
       RC.OPERATION2,
       RC.OPERATION3,
       RC.OPERATION4,
       RC.OPERATION5,
       RC.OPERATION6) F2
GROUP BY F2.INDEX_CODE,
       F2.PRODUCT_CODE) RES
ON RCS.INDEX_CODE = RES.INDEX_CODE
AND RES.PRODUCT_CODE LIKE RCS.CONDITION1
WHERE RCS.REPORT_TYPE = '1'
GROUP BY /*RCS.ORD,
       RES.INDEX_CODE,*/
       RCS.COLUMN_CODE,
       RCS.ROW_CODE,
       RCS.ROW_NAME,
       RCS.ROW_NAME_EN) RES2
PIVOT (SUM(RES2.VALUE) FOR COLUMN_CODE IN 
      (1 AS VALUE1,2 AS VALUE2,3 AS VALUE3,4 AS VALUE4,5 AS VALUE5,6 AS VALUE6,
      7 AS VALUE7,8 AS VALUE8,9 AS VALUE9,10 AS VALUE10,11 AS VALUE11));